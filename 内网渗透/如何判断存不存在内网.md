参考链接：

- [内网渗透之内网主机发现技巧](https://www.wangan.com/p/7fy7fg2ddf37decb)

# 0x00 背景
为什么会出现没有`ipconfig`/`ifconfig`命令？主要是两点原因：

- 处于docker环境
   - 查`/.dockerenv`文件是否存在；
   - 检查`/proc/1/cgroup`内是否包含"docker"等字符串；
   - 检查是否存在`container`环境变量；
   - 查看`2375/2376`端口是否开放。
- Linux发行版本不同

<div align=center><img src="https://user-images.githubusercontent.com/84888757/233153307-7238826b-9fce-497e-b89e-ddf001b1bc7a.png" /></div>



某次打点成功后发现没有`ipconfig /all`命令，那么此时如何判断存不存在内网？

- `arp -a`
- `cat /proc/arp`
- `cat /etc/hosts`
- 查看进程，有没有什么服务，去对应文件夹翻找配置文件。
- 通过什么洞打点成功 -> 比如泛微 -> 查看泛微配置文件，比如数据库配置文件，数据库系统可能在另一台内网服务器上，从而确认存在内网。

如何在不使用扫描器的情况下发现更多主机呢？

**以下部分转载自 **[**内网渗透之内网主机发现技巧 @信安之路**](https://www.wangan.com/p/7fy7fg2ddf37decb)</div><br />**（补充了一点点）**


# 0x01 确定IP段
通常内网地址分三段：10.0.0.0/8、172.16.0.0/12以及192.168.0.0/16。在没有做任何操作之前，我们可以大概知道内网的IP地址段，不过也有些公司，在内网又会有公网IP的情况，也就是说在内网中可以访问到的IP段有很多。

---

下面就主要介绍一下收集IP段的方式。

## 查看本机的IP地址
Windows下使用：
> ipconfig /all

Linux下使用：
> ifconfig -a

以Windows为例，执行结果如图：

<div align=center><img src="https://cdn.nlark.com/yuque/0/2022/jpeg/22669825/1657198912806-30dd084a-ad15-45e3-92b1-26c3fcee56c8.jpeg#averageHue=%230d0c0c&clientId=u386eba42-01c0-4&from=paste&id=ueae50700&originHeight=794&originWidth=640&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=ue1a7a042-31d4-4c79-ab40-e33fd653f69&title=" /></div><br />从图中看到，我本机的IP以及下面的子网掩码，可以说明我所在的IP段是一个C段，我们就可以首先探测一下我所处的IP段，即：192.168.188.0/24。<br />图中还有一个IP值得注意，就是dns服务器的IP，通常在内网中，DNS服务器的IP地址未必与我们在同一个C段或者B段，所以从这里也可以看到一个存在的IP段，也是我们要做主机发现扫描的目标IP段。

---

<a name="IaNfx"></a>
## 查看路由表
Windows下使用：
> route print

linux下使用：
> route -n

以Windows为例，结果如图：<br /><div align=center><img src="https://cdn.nlark.com/yuque/0/2022/jpeg/22669825/1657198912711-e6a5b164-3ae9-4aa0-aaf4-25b862e0b018.jpeg#averageHue=%23161515&clientId=u386eba42-01c0-4&from=paste&id=ua21f03de&originHeight=570&originWidth=632&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u34fff649-cdc0-4b7b-84a1-314bf0abc18&title=" /></div><br />在上图可以看出，在路由表中也存在我们上面确定的IP段，这是我自己家的网络，所以没有那么复杂，大家在实际环境或者公司网络中可以看到有多个IP段，这些IP段都是我们可以访问到的，也是要做主机发现扫描的目标IP段。

---


## 查看本地连接信息
Windows下执行：
> netstat -ano

linux下执行：
> netstat -anp

以Windows为例执行结果如图：<br /><div align=center><img src="https://cdn.nlark.com/yuque/0/2022/jpeg/22669825/1657198912814-27934a2d-b850-4557-b0fa-5a3179b4789f.jpeg#averageHue=%231b1a1a&clientId=u386eba42-01c0-4&from=paste&id=u9283ed76&originHeight=700&originWidth=634&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u21cf88d1-6833-4272-abc2-3804632d3d0&title=" /></div><br />从图中看到有很多的IP连接信息，我们并没有看到内网的IP地址，那是因为内网没有主机与我这台主机相连，你想象一下，如果我这台主机是台服务器，那么内网用户访问服务器时必定会有连接出现，这也是我们收集内网IP段信息的一种方式。

---


## 利用net命令
我们知道，在Windows内网环境下，我们可以使用
> net view

命令用于显示一个计算机上共享资源的列表。我们从这个资源列表可以获取到一些主机名，然后解析出IP地址，这样不光收集到了一些存活主机，而且还收集了一些IP段。由于没有环境，就盗用网络上的图来填补一下：<br />
<div align=center><img src="https://cdn.nlark.com/yuque/0/2022/gif/22669825/1657198912629-9e6e8dba-9708-41e5-8ff5-c508ecb8e7bd.gif#averageHue=%23000000&clientId=u386eba42-01c0-4&from=paste&id=ubfffe044&name=image.png&originHeight=1&originWidth=1&originalType=url&ratio=1&rotation=0&showTitle=false&size=70&status=done&style=none&taskId=u78e30845-800f-4564-bb6b-4fed35eccd5&title=" /></div><div align=center><img src="https://cdn.nlark.com/yuque/0/2022/png/22669825/1657199019302-10c0e0f1-65ec-43ea-b650-6a7289458e81.png#averageHue=%23121211&clientId=u386eba42-01c0-4&from=paste&id=u7b412634&name=image.png&originHeight=154&originWidth=640&originalType=url&ratio=1&rotation=0&showTitle=false&size=20090&status=done&style=none&taskId=ua6a23c8a-682c-471e-b388-12f98034f47&title=" /></div>

---

我们还可以使用
> net session

命令来查看管理员的登录IP，linux下可以使用
> who

来查看，从这里也可以收集几个IP地址，如果管理员登录在线的情况下，盗图如下：<br /><div align=center><img src="https://cdn.nlark.com/yuque/0/2022/jpeg/22669825/1657198912658-a5179cb3-c00b-4cf4-ac53-c77243201e96.jpeg#averageHue=%23333333&clientId=u386eba42-01c0-4&from=paste&id=u68ce0e52&originHeight=175&originWidth=640&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=ub64d3239-44a3-42ab-b4de-38176bce3c6&title=" /></div>

---

与上面同样的原理，我们可以远程列出像文件服务器上连接的用户信息，我们可以使用老外提供的一个工具netsess.exe来远程列举，命令如下：
> netsess.exe -h dc01 或 netsess.exe \dc01

结果如图：<br /><div align=center><img src="https://cdn.nlark.com/yuque/0/2022/png/22669825/1657198913246-5874dc40-7307-4ae0-9090-816396007d04.png#averageHue=%231e1e1d&clientId=u386eba42-01c0-4&from=paste&id=udd8d7396&originHeight=444&originWidth=573&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=ud0f1760f-d683-43b9-a0ad-b9ea3b8f72e&title=" /></div>

## 利用dns信息
当我们进入内网的时候，第一时间，我们应该先探测一下内网的dns服务是否存在dns域传送漏洞，如果存在，我们就可以剩下很多时间并且可以获取非常全的域名列表，这个列表基本很全的包含了内网所有的存活主机。如何探测dns域传送[请点我](http://mp.weixin.qq.com/s?__biz=MzI5MDQ2NjExOQ==&mid=2247483722&idx=1&sn=0ca58973b1257a410ff13111134da931&chksm=ec1e3162db69b87461b7d881cc43384afa2f2a41a5d529f5ad7dc13eddfee70ad4e9136ecef5&scene=21#wechat_redirect)</div>。<br />如果不存在dns域传送漏洞，在我们收集了一定的主机名之后，我们可以根据主机名的命名规则生成一份主机名字典，然后使用dns解析这些名字，获得IP之后，再根据IP确定IP段。

## 利用域信息
如果我们已经获取到一台域内的主机权限，那么我们就可以访问域内的所有信息，这是就可以通过域控制器查询加入域中的所有主机信息，可以使用如下命令获取：
> dsquery computer 以及 dsquery server

获得主机以及服务器列表后，解析其IP获取IP段信息。

---

用以上几种方式，在新获取到一台主机权限之后做一下这个处理，就可能会收集到更多的IP段。但是有人说了，这样做多累啊，直接使用Namp或者其他大型扫描器多线程扫描内网的所有IP段不就行了，这样做当然可以，但是这个动静多大，会造成各种安全设备报警，还没赶上进一步渗透，你就直接game over了。

在内网的活动要非常谨慎，动静越小越好。

下面就介绍一下如何用尽量小的动静发现更多的主机。


## 利用日志信息

### ssh日志
> cat /var/log/auth.log

<div align=center><img src="https://user-images.githubusercontent.com/84888757/233148357-eb902277-e975-4028-819b-701688e1dcaf.png" /></div>


### 历史命令
linux下执行：
> history
> 
> cat /home/username/.bash_history
> 
> cat /root/.bash_history


Windows下执行：<br />（by pen4uin）
> PowerShell命令历史记录
> 
> -- 类似Linux下的`.bash_history`
> 
> 文件位置如下：

```shell
%userprofile%\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt
```
<div align=center><img src="https://cdn.nlark.com/yuque/0/2022/png/22669825/1650389144862-57469cad-9b16-4d16-b119-dd8d06212dbf.png#averageHue=%23f7f7f6&clientId=u69f71428-a328-4&from=paste&height=305&id=ue3ca4bbb&name=image.png&originHeight=305&originWidth=671&originalType=binary&ratio=1&rotation=0&showTitle=false&size=19400&status=done&style=none&taskId=uc77b52bb-b990-486c-96df-ea53c381227&title=&width=671" /></div><br /><div align=center><img src="https://cdn.nlark.com/yuque/0/2022/png/22669825/1656905910935-90552a3f-11b0-423b-abc4-109f21567b0d.png#averageHue=%230f1518&clientId=u95be00a0-14ab-4&from=paste&height=186&id=u9d087dea&name=image.png&originHeight=186&originWidth=1432&originalType=binary&ratio=1&rotation=0&showTitle=false&size=253818&status=done&style=none&taskId=u2fe47e69-1ece-4656-982a-5d459a01e9c&title=&width=1432" /></div>

## 使用arp命令
地址解析协议，即ARP（Address Resolution Protocol），是根据IP地址获取物理地址的一个TCP/IP协议。在解析过IP之后会保存在本地的arp表中，所以使用以下命令可以查看本地的arp缓存表，从中获取到一些IP信息。
> arp -a

Windows：<br /><div align=center><img src="https://cdn.nlark.com/yuque/0/2022/png/22669825/1657198913303-32d5a0fb-1a8a-4406-9413-8f40aa4bcaca.png#averageHue=%23131313&clientId=u386eba42-01c0-4&from=paste&id=cJAoq&originHeight=215&originWidth=493&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u7360983e-feaa-4c47-aae4-99c98806c37&title=" /></div><br />

Linux：<br /><div align=center><img src="image.png" /></div><br />通过查看文件的方式更加清晰
> cat /proc/net/arp



<div align=center><img src="https://user-images.githubusercontent.com/84888757/233147345-0077c251-c8dd-417d-8a8d-f7d9e0b1261c.png" /></div>



## 使用nbtstat
`NBTSTAT` 命令可以用来查询涉及到NetBIOS信息的网络机器。首先看一下帮助信息：<br /><div align=center><img src="https://cdn.nlark.com/yuque/0/2022/png/22669825/1657198913490-b5a94e87-6e00-4dff-9199-9b4b089017ef.png#averageHue=%23111111&clientId=u386eba42-01c0-4&from=paste&id=LvMuc&originHeight=416&originWidth=640&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=ufb7feedf-2416-4013-a0b4-90c5b81f167&title=" /></div><br />

可以使用如下命令查看缓存信息：
> nbtstat -c

<div align=center><img src="https://cdn.nlark.com/yuque/0/2022/png/22669825/1657198913697-1733dc55-a46b-4701-8085-5180ee26525b.png#averageHue=%230c0c0c&clientId=u386eba42-01c0-4&from=paste&id=uzMHE&originHeight=114&originWidth=456&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u8eda9265-4094-469f-9d10-4c5cda404c7&title=" /></div>

## 查看本地的hosts文件
Hosts是一个没有扩展名的系统文件，可以用记事本等工具打开，其作用就是将一些常用的网址域名与其对应的IP地址建立一个关联"数据库"，当用户在浏览器中输入一个需要登录的网址时，系统会首先自动从Hosts文件中寻找对应的IP地址，一旦找到，系统会立即打开对应网页，如果没有找到，则系统会再将网址提交DNS域名解析服务器进行IP地址的解析。查看文件内容可以用下面的命令：<br />Windows：
> type c:\Windows\system32\drivers\etc\hosts

<div align=center><img src="https://cdn.nlark.com/yuque/0/2022/png/22669825/1657198913664-4ba95a37-aaf7-41fc-977b-628424a6445b.png#averageHue=%230f0f0f&clientId=u386eba42-01c0-4&from=paste&id=jv2Qo&originHeight=420&originWidth=587&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=uee69fe7b-1d63-44b9-9a6a-d9e22026a66&title=" /></div><br />

Linux：
> cat /etc/hosts

<div align=center><img src="https://cdn.nlark.com/yuque/0/2022/jpeg/22669825/1657198913663-12dbf5d9-e033-4ff7-b9a6-467a1647f232.jpeg#averageHue=%2316232b&clientId=u386eba42-01c0-4&from=paste&id=XABUI&originHeight=150&originWidth=576&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u30c7ff33-4428-49f5-a201-a549998b360&title=" /></div><br />

**查看本地dns缓存**

dns缓存中存在我们解析过的域名信息，当然，也会存在内网中的域名信息，所以查看这些信息也有助于我们发现内网的IP段。<br />

Windows：
> ipconfig /displaydns

<div align=center><img src="https://cdn.nlark.com/yuque/0/2022/png/22669825/1657198913756-b8db1dd6-4f3f-4c0f-b822-d4daee680c62.png#averageHue=%23080808&clientId=u386eba42-01c0-4&from=paste&id=d4owS&originHeight=529&originWidth=574&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=ubb0067b7-8a89-47e9-bbd3-cdf151aad60&title=" /></div><br />

Linux下需要安装nscd并且配置它才能缓存dns信息，所以这里就不做介绍。

## 查看本地用户的连接信息
这种方式就是收集用户的使用软件的连接记录，像vpn、filezilla、securecrt、winscp、putty等需要远程连接的软件，这里就提一下，不做过多解释，大家自由发挥吧。

## 其他linux下的命令
findsmb<br /><div align=center><img src="https://cdn.nlark.com/yuque/0/2022/jpeg/22669825/1657198913964-56815862-f631-4902-96fb-a09b07a47f39.jpeg#averageHue=%23112029&clientId=u386eba42-01c0-4&from=paste&id=QuoIV&originHeight=111&originWidth=640&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u6cb8623c-9a9e-468a-84ed-cbefffb5dd4&title=" /></div><br />ip neigh show<br /><div align=center><img src="https://cdn.nlark.com/yuque/0/2022/jpeg/22669825/1657198914131-7b2f85f2-768c-401c-ae06-a3718519e40e.jpeg#averageHue=%23233139&clientId=u386eba42-01c0-4&from=paste&id=qRbQx&originHeight=57&originWidth=585&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u541f5182-b742-4e59-91b9-530b1cb9d9b&title=" /></div>

`smbtree` 以及 `smbclient -L 192.168.7.42` #由于我本地没有域环境就不做测试了

# 0x02 如何扫描IP段发现存活主机
在Windows或者linux下都有一个命令：`ping`，这个命令的功能就是为了网管员在配置完网络后用来探测网络连通性的，我们可以利用这个工具，写一些简单脚本来批量探测主机是否存活，虽然速度慢点，但是安全可靠，不易被识别。

## ping扫描
Windows下可以使用：
> ping -n 1 127.0.0.1

linux下使用：
> ping -c 1 127.0.0.1

知道核心命令之后，可以编写一个批量扫描的脚本来完成这个操作。<br />

（by [Tuuu Nya](https://www.hackersb.cn/hacker/44.html)）
```shell
@echo off 
setlocal ENABLEDELAYEDEXPANSION 
 @FOR /F "usebackq eol=- skip=1 delims=\" %%j IN (`net view ^| find "命令成功完成" /v ^|find
 "The command completed successfully." /v`) DO ( 
 @FOR /F "usebackq delims=" %%i IN (`@ping -n 1 -4 %%j ^| findstr "Pinging"`) DO ( 
 @FOR /F "usebackq tokens=2 delims=[]" %%k IN (`echo %%i`) DO (echo \\%%k  [%%j]) 
 ) 
 ) 
```

# 0x03 扫描工具
在确定内网中存在的IP段之后，我们需要扫描判断哪些主机存活，这样才能进一步的渗透，在之前的文章中我主要提了一个就是使用ping扫描，今天做一下补充，不管大家用不用，了解一下还是可以的。

## fscan

- [https://github.com/shadow1ng/fscan](https://github.com/shadow1ng/fscan)

## nbtscan
nbtscan是一个扫描WINDOWS网络NetBIOS信息的小工具，下载地址：
> http://unixwiz.net/tools/nbtscan.html

可以使用以下命令来发现主机：
> nbtscan-1.0.35.exe 192.168.188.0/24

<div align=center><img src="https://cdn.nlark.com/yuque/0/2022/gif/22669825/1657198914009-278494f1-12ea-4f05-81fb-aac9fa7d494a.gif#averageHue=%23000000&clientId=u386eba42-01c0-4&from=paste&id=u615f91e4&name=image.png&originHeight=1&originWidth=1&originalType=url&ratio=1&rotation=0&showTitle=false&size=70&status=done&style=none&taskId=u4ac314c8-9fc7-4895-8243-83bae8bd4be&title=" /></div>

<div align=center><img src="https://cdn.nlark.com/yuque/0/2022/png/22669825/1657199978984-86e41c49-3181-4477-890b-0c4ef1d3f397.png#averageHue=%23191919&clientId=u386eba42-01c0-4&from=paste&id=u4813c243&originHeight=54&originWidth=497&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=udf7631ef-8a82-4e18-a7da-919439fb4f7&title=" /></div>

kali自带nbtscan工具，可在做代理后进行内网信息收集。<br />大家可以自行查看帮助，测试如何使用。

## netdiscover
netdiscover是基于ARP的网络扫描工具，kali下自带这个工具，可以使用如下命令扫描：
> netdiscover -r 192.168.88.0/24


<div align=center><img src="https://cdn.nlark.com/yuque/0/2022/jpeg/22669825/1657198914139-3101962f-e84b-467e-8a19-575d8aa67849.jpeg#averageHue=%231d282f&clientId=u386eba42-01c0-4&from=paste&id=ua13c99b1&originHeight=169&originWidth=640&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u68220e1a-f2dc-4500-bd9e-1b69f9a7ba3&title=" /></div>

## nmap
nmap大家众所周知，非常强大的端口扫描工具，可以使用以下命令扫描存活主机：
> nmap -n -Pn -T5 -sS 192.168.88.0/24

<div align=center><img src="https://cdn.nlark.com/yuque/0/2022/jpeg/22669825/1657198914237-c86ee527-45b9-4d6f-936f-377b9379e530.jpeg#averageHue=%2316232b&clientId=u386eba42-01c0-4&from=paste&id=u532170ac&originHeight=428&originWidth=640&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=ue316ba27-12f4-43ba-8ff6-01a9c03a3b2&title=" /></div>

